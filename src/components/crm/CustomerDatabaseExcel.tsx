import { useState, useEffect, useRef } from 'react';
import { supabase } from '../../lib/supabase';
import { Plus, Download, Upload, Trash2, Save } from 'lucide-react';

interface Customer {
  id: string;
  company_name: string;
  contact_person: string | null;
  designation: string | null;
  email: string | null;
  mobile: string | null;
  landline: string | null;
  phone: string | null;
  country: string | null;
  city: string | null;
  address: string | null;
  website: string | null;
  customer_type: string | null;
  notes: string | null;
  is_active: boolean;
}

interface EditingCell {
  rowId: string;
  field: string;
}

export function CustomerDatabaseExcel() {
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingCell, setEditingCell] = useState<EditingCell | null>(null);
  const [editValue, setEditValue] = useState('');
  const [selectedRows, setSelectedRows] = useState<Set<string>>(new Set());
  const [columnWidths, setColumnWidths] = useState<Record<string, number>>({
    company_name: 200,
    contact_person: 150,
    designation: 120,
    email: 180,
    mobile: 130,
    landline: 130,
    phone: 130,
    country: 120,
    city: 120,
    address: 200,
    website: 150,
    customer_type: 120,
    notes: 200,
  });
  const [resizing, setResizing] = useState<{ column: string; startX: number; startWidth: number } | null>(null);
  const tableRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    loadCustomers();
  }, []);

  useEffect(() => {
    if (resizing) {
      const handleMouseMove = (e: MouseEvent) => {
        const diff = e.clientX - resizing.startX;
        const newWidth = Math.max(80, resizing.startWidth + diff);
        setColumnWidths(prev => ({ ...prev, [resizing.column]: newWidth }));
      };

      const handleMouseUp = () => {
        setResizing(null);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [resizing]);

  const loadCustomers = async () => {
    try {
      const { data, error } = await supabase
        .from('crm_contacts')
        .select('*')
        .order('company_name');

      if (error) throw error;
      setCustomers(data || []);
    } catch (error) {
      console.error('Error loading customers:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleCellDoubleClick = (customer: Customer, field: string) => {
    setEditingCell({ rowId: customer.id, field });
    setEditValue((customer[field as keyof Customer] as string) || '');
  };

  const handleCellBlur = async () => {
    if (!editingCell) return;

    try {
      const { error } = await supabase
        .from('crm_contacts')
        .update({ [editingCell.field]: editValue || null })
        .eq('id', editingCell.rowId);

      if (error) throw error;

      setCustomers(prev =>
        prev.map(c =>
          c.id === editingCell.rowId
            ? { ...c, [editingCell.field]: editValue || null }
            : c
        )
      );
    } catch (error) {
      console.error('Error updating customer:', error);
      alert('Failed to update customer');
    } finally {
      setEditingCell(null);
      setEditValue('');
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleCellBlur();
    } else if (e.key === 'Escape') {
      setEditingCell(null);
      setEditValue('');
    }
  };

  const handleAddRow = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase
        .from('crm_contacts')
        .insert({
          company_name: 'New Customer',
          is_active: true,
          created_by: user.id,
        })
        .select()
        .single();

      if (error) throw error;
      setCustomers(prev => [data, ...prev]);
    } catch (error) {
      console.error('Error adding customer:', error);
      alert('Failed to add customer');
    }
  };

  const handleDeleteSelected = async () => {
    if (selectedRows.size === 0) return;
    if (!confirm(`Delete ${selectedRows.size} customer(s)?`)) return;

    try {
      const { error } = await supabase
        .from('crm_contacts')
        .delete()
        .in('id', Array.from(selectedRows));

      if (error) throw error;
      setCustomers(prev => prev.filter(c => !selectedRows.has(c.id)));
      setSelectedRows(new Set());
    } catch (error) {
      console.error('Error deleting customers:', error);
      alert('Failed to delete customers');
    }
  };

  const toggleRowSelection = (id: string) => {
    setSelectedRows(prev => {
      const newSet = new Set(prev);
      if (newSet.has(id)) {
        newSet.delete(id);
      } else {
        newSet.add(id);
      }
      return newSet;
    });
  };

  const toggleSelectAll = () => {
    if (selectedRows.size === customers.length) {
      setSelectedRows(new Set());
    } else {
      setSelectedRows(new Set(customers.map(c => c.id)));
    }
  };

  const exportToExcel = () => {
    const headers = ['Company Name', 'Contact Person', 'Designation', 'Email', 'Mobile', 'Landline', 'Phone', 'Country', 'City', 'Address', 'Website', 'Customer Type', 'Notes'];
    const rows = customers.map(c => [
      c.company_name,
      c.contact_person || '',
      c.designation || '',
      c.email || '',
      c.mobile || '',
      c.landline || '',
      c.phone || '',
      c.country || '',
      c.city || '',
      c.address || '',
      c.website || '',
      c.customer_type || '',
      c.notes || '',
    ]);

    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  const renderCell = (customer: Customer, field: keyof Customer) => {
    const isEditing = editingCell?.rowId === customer.id && editingCell?.field === field;
    const value = customer[field];

    if (isEditing) {
      return (
        <input
          type="text"
          value={editValue}
          onChange={(e) => setEditValue(e.target.value)}
          onBlur={handleCellBlur}
          onKeyDown={handleKeyDown}
          autoFocus
          className="w-full h-full px-2 py-1 border-2 border-blue-500 focus:outline-none bg-white"
        />
      );
    }

    return (
      <div
        onDoubleClick={() => handleCellDoubleClick(customer, field as string)}
        className="px-2 py-1 cursor-cell hover:bg-gray-50 h-full flex items-center"
        title="Double-click to edit"
      >
        {field === 'is_active' ? (
          <span className={`px-2 py-0.5 rounded text-xs ${value ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`}>
            {value ? 'Active' : 'Inactive'}
          </span>
        ) : (
          <span className="truncate">{value?.toString() || '-'}</span>
        )}
      </div>
    );
  };

  const startResize = (e: React.MouseEvent, column: string) => {
    e.preventDefault();
    setResizing({
      column,
      startX: e.clientX,
      startWidth: columnWidths[column],
    });
  };

  if (loading) {
    return <div className="flex items-center justify-center h-64">Loading customers...</div>;
  }

  return (
    <div className="flex flex-col h-full bg-white rounded-lg shadow">
      {/* Toolbar */}
      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200">
        <div className="flex items-center gap-2">
          <button
            onClick={handleAddRow}
            className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm"
          >
            <Plus className="w-4 h-4" />
            Add Customer
          </button>
          {selectedRows.size > 0 && (
            <button
              onClick={handleDeleteSelected}
              className="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm"
            >
              <Trash2 className="w-4 h-4" />
              Delete ({selectedRows.size})
            </button>
          )}
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={exportToExcel}
            className="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm"
          >
            <Download className="w-4 h-4" />
            Export CSV
          </button>
        </div>
      </div>

      {/* Table */}
      <div ref={tableRef} className="flex-1 overflow-auto" style={{ maxHeight: 'calc(100vh - 250px)' }}>
        <table className="w-full border-collapse">
          <thead className="sticky top-0 bg-gray-50 z-10">
            <tr>
              <th className="border border-gray-300 px-2 py-2 bg-gray-100 w-10">
                <input
                  type="checkbox"
                  checked={selectedRows.size === customers.length && customers.length > 0}
                  onChange={toggleSelectAll}
                  className="rounded"
                />
              </th>
              {[
                { key: 'company_name', label: 'Company Name' },
                { key: 'contact_person', label: 'Contact Person' },
                { key: 'designation', label: 'Designation' },
                { key: 'email', label: 'Email' },
                { key: 'mobile', label: 'Mobile' },
                { key: 'landline', label: 'Landline' },
                { key: 'phone', label: 'Phone' },
                { key: 'country', label: 'Country' },
                { key: 'city', label: 'City' },
                { key: 'address', label: 'Address' },
                { key: 'website', label: 'Website' },
                { key: 'customer_type', label: 'Type' },
                { key: 'notes', label: 'Notes' },
              ].map(({ key, label }) => (
                <th
                  key={key}
                  className="border border-gray-300 px-2 py-2 bg-gray-100 text-left text-xs font-semibold text-gray-700 relative"
                  style={{ width: columnWidths[key], minWidth: columnWidths[key] }}
                >
                  <div className="flex items-center justify-between">
                    <span>{label}</span>
                    <div
                      onMouseDown={(e) => startResize(e, key)}
                      className="absolute right-0 top-0 bottom-0 w-1 cursor-col-resize hover:bg-blue-500 hover:w-1.5 transition-all"
                      style={{ touchAction: 'none' }}
                    />
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {customers.map((customer) => (
              <tr
                key={customer.id}
                className={`${selectedRows.has(customer.id) ? 'bg-blue-50' : 'hover:bg-gray-50'} transition`}
              >
                <td className="border border-gray-300 px-2 py-1 text-center">
                  <input
                    type="checkbox"
                    checked={selectedRows.has(customer.id)}
                    onChange={() => toggleRowSelection(customer.id)}
                    className="rounded"
                  />
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.company_name }}>
                  {renderCell(customer, 'company_name')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.contact_person }}>
                  {renderCell(customer, 'contact_person')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.designation }}>
                  {renderCell(customer, 'designation')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.email }}>
                  {renderCell(customer, 'email')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.mobile }}>
                  {renderCell(customer, 'mobile')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.landline }}>
                  {renderCell(customer, 'landline')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.phone }}>
                  {renderCell(customer, 'phone')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.country }}>
                  {renderCell(customer, 'country')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.city }}>
                  {renderCell(customer, 'city')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.address }}>
                  {renderCell(customer, 'address')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.website }}>
                  {renderCell(customer, 'website')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.customer_type }}>
                  {renderCell(customer, 'customer_type')}
                </td>
                <td className="border border-gray-300 h-8" style={{ width: columnWidths.notes }}>
                  {renderCell(customer, 'notes')}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Footer */}
      <div className="px-4 py-2 border-t border-gray-200 bg-gray-50 text-sm text-gray-600">
        <div className="flex items-center justify-between">
          <span>{customers.length} customer(s) total</span>
          <span className="text-xs text-gray-500">Double-click any cell to edit â€¢ Drag column borders to resize</span>
        </div>
      </div>
    </div>
  );
}
